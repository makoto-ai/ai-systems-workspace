name: Canary Auto Promote

on:
  schedule:
    # æ¯æ—¥ 09:10 JST (00:10 UTC)
    - cron: '10 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual PR actions)'
        type: boolean
        default: false
      days:
        description: 'Evaluation window (days)'
        type: number
        default: 7

jobs:
  canary-auto-promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´å–å¾—ã®ãŸã‚

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r dashboard/requirements.txt

      - name: Evaluate 7-day canary window
        id: evaluate
        run: |
          echo "ğŸ“Š ã‚«ãƒŠãƒªã‚¢é€±7æ—¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è©•ä¾¡é–‹å§‹"
          
          DAYS="${{ github.event.inputs.days || 7 }}"
          echo "è©•ä¾¡æœŸé–“: ${DAYS}æ—¥"
          
          python scripts/evaluate_canary_window.py \
            --days ${DAYS} \
            --out out/canary_window.json
          
          # è©•ä¾¡çµæœã®ç¢ºèª
          if [ -f out/canary_window.json ]; then
            echo "âœ… 7æ—¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è©•ä¾¡å®Œäº†"
            cat out/canary_window.json | jq '.'
          else
            echo "âŒ è©•ä¾¡çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: Decide canary action
        id: decide
        run: |
          echo "ğŸ¤– ã‚«ãƒŠãƒªã‚¢è‡ªå‹•åˆ¤å®šé–‹å§‹"
          
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ğŸ§ª Dry Run ãƒ¢ãƒ¼ãƒ‰"
          fi
          
          python scripts/decide_canary_action.py \
            --window out/canary_window.json \
            --pr-url "https://github.com/${{ github.repository }}/pull/29" \
            --auto-merge \
            --create-issue-on-fail \
            $DRY_RUN_FLAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload canary evaluation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: canary-evaluation-${{ github.run_number }}
          path: |
            out/canary_window.json
            out/shadow_0_7*.json
            out/notify_payload.json
          retention-days: 30

      - name: Notify Slack (Auto Promote Result)
        if: always()
        run: |
          echo "ğŸ“¤ è‡ªå‹•æ˜‡æ ¼çµæœã‚’Slacké€šçŸ¥"
          
          # åˆ¤å®šçµæœã®å–å¾—
          if [ -f out/canary_window.json ]; then
            DECISION=$(jq -r '.decision // "unknown"' out/canary_window.json)
            PASS_RATE=$(jq -r '.metrics.avg_pass_rate // 0' out/canary_window.json)
            FLAKY_RATE=$(jq -r '.metrics.avg_flaky_rate // 0' out/canary_window.json)
            NEW_FAIL_RATIO=$(jq -r '.metrics.avg_new_fail_ratio // 0' out/canary_window.json)
            
            echo "åˆ¤å®šçµæœ: $DECISION"
            echo "å¹³å‡åˆæ ¼ç‡: $PASS_RATE%"
            echo "å¹³å‡Flakyç‡: $FLAKY_RATE%"
            echo "å¹³å‡æ–°è¦å¤±æ•—ç‡: $NEW_FAIL_RATIO%"
            
            # Slacké€šçŸ¥ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              python scripts/notify_canary_decision.py \
                --decision "$DECISION" \
                --window out/canary_window.json \
                --action-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            fi
          else
            echo "âš ï¸ åˆ¤å®šçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Safety check (consecutive failures)
        run: |
          echo "ğŸ›¡ï¸ ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆç¢ºèª"
          
          # é€£ç¶šå¤±æ•—ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
          python scripts/check_consecutive_failures.py \
            --threshold 2 \
            --escalate-on-exceed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Success summary
        if: success()
        run: |
          echo "âœ… ã‚«ãƒŠãƒªã‚¢è‡ªå‹•æ˜‡æ ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†"
          echo "ğŸ“Š è©•ä¾¡æœŸé–“: ${{ github.event.inputs.days || 7 }}æ—¥"
          echo "ğŸ¤– åˆ¤å®šçµæœ: $(jq -r '.decision // "unknown"' out/canary_window.json)"
          echo "ğŸ“ˆ è©³ç´°ã¯Artifactã‚’ç¢ºèªã—ã¦ãã ã•ã„"
