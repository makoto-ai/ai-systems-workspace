name: Golden Test Canary Auto-Promote

on:
  schedule:
    # æ¯æ—¥18:00 JSTã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼·åˆ¶ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  canary-evaluation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyyaml  # Phase4 weighted evaluationç”¨

    - name: Setup environment
      run: |
        echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

    - name: Run Shadow Evaluation (Phase4æº–å‚™ãƒã‚§ãƒƒã‚¯)
      id: shadow_eval
      run: |
        echo "ğŸ” Running Phase 4 Shadow Evaluation..."

        # Phase4å‘ã‘ãƒãƒ«ãƒã‚·ãƒ£ãƒ‰ãƒ¼è©•ä¾¡å®Ÿè¡Œ
        python tests/golden/runner.py \
          --threshold-shadow "0.7,0.85" \
          --report out/shadow_multi.json \
          --weights tests/golden/weights_phase4.yaml

        echo "âœ… Shadow evaluation completed"

        # çµæœè§£æ
        PREDICTED_AT_85=$(python -c "
        import json
        with open('out/shadow_multi.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        threshold_85 = thresholds.get('0.85', {})
        weighted_rate = threshold_85.get('weighted_pass_rate', threshold_85.get('shadow_pass_rate', 0))
        print(f'{weighted_rate:.1f}')
        ")

        echo "predicted_at_85=${PREDICTED_AT_85}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Predicted@0.85: ${PREDICTED_AT_85}%"

    - name: Check Phase4 æº–å‚™çŠ¶æ³
      id: phase4_check
      run: |
        PREDICTED_AT_85="${{ steps.shadow_eval.outputs.predicted_at_85 }}"

        # Phase4æ¡ä»¶ãƒã‚§ãƒƒã‚¯
        if (( $(echo "$PREDICTED_AT_85 >= 85" | bc -l) )); then
          echo "ready_for_phase4=true" >> $GITHUB_OUTPUT
          echo "âœ… Phase 4æº–å‚™å®Œäº†: Predicted@0.85=${PREDICTED_AT_85}%"
        else
          GAP=$(echo "85 - $PREDICTED_AT_85" | bc -l)
          echo "ready_for_phase4=false" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Phase 4æº–å‚™ä¸­: Gap=${GAP}pp"
        fi

    - name: Check å±¥æ­´ï¼ˆ2é€±é€£ç¶šãƒã‚§ãƒƒã‚¯ï¼‰
      id: history_check
      if: steps.phase4_check.outputs.ready_for_phase4 == 'true'
      run: |
        echo "ğŸ“… Checking 2-week consecutive achievement..."

        # éå»2é€±é–“ã®Phase4æº–å‚™çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        # ç°¡ç•¥åŒ–: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ + æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
        WEEK_1_FILE="out/phase4_ready_$(date -d '7 days ago' +'%Y%m%d').marker"
        WEEK_2_FILE="out/phase4_ready_$(date -d '14 days ago' +'%Y%m%d').marker"

        if [ -f "$WEEK_1_FILE" ]; then
          echo "âœ… 1é€±é–“å‰ã‚‚æ¡ä»¶é”æˆ"
          if [ -f "$WEEK_2_FILE" ]; then
            echo "consecutive_weeks=2" >> $GITHUB_OUTPUT
            echo "ğŸ‰ 2é€±é€£ç¶šã§Phase4æ¡ä»¶é”æˆï¼"
          else
            echo "consecutive_weeks=1" >> $GITHUB_OUTPUT
            echo "ğŸ“… 1é€±é€£ç¶šï¼ˆ2é€±ç›®å¾…ã¡ï¼‰"
          fi
        else
          echo "consecutive_weeks=0" >> $GITHUB_OUTPUT
          echo "ğŸ”„ ä»Šé€±ãŒåˆå›é”æˆ"
        fi

        # ä»Šå›ã®é”æˆã‚’ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        mkdir -p out
        touch "out/phase4_ready_$(date +'%Y%m%d').marker"

    - name: Phase4è‡ªå‹•æ˜‡æ ¼åˆ¤å®š
      id: auto_promote
      if: steps.phase4_check.outputs.ready_for_phase4 == 'true' && steps.history_check.outputs.consecutive_weeks == '2'
      run: |
        echo "ğŸš€ Phase 4è‡ªå‹•æ˜‡æ ¼æ¡ä»¶é”æˆï¼"
        echo "auto_promote=true" >> $GITHUB_OUTPUT

        # æ˜‡æ ¼é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
        echo '{
          "phase": "phase4",
          "timestamp": "'$(date -Iseconds)'",
          "predicted_at_85": '${{ steps.shadow_eval.outputs.predicted_at_85 }}',
          "consecutive_weeks": 2,
          "auto_promoted": true
        }' > out/phase4_promotion.json

        echo "ğŸ“„ æ˜‡æ ¼ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†"

    - name: ready-for-phase4 ãƒ©ãƒ™ãƒ«è‡ªå‹•ä»˜ä¸
      if: steps.auto_promote.outputs.auto_promote == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Issue/PRã« ready-for-phase4 ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'golden-test',
            state: 'open'
          });

          for (const issue of issues) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['ready-for-phase4']
            });
          }

          // æ–°ã—ã„Issueã‚’ä½œæˆ
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš€ Phase 4 Auto-Promotion Ready',
            body: `## Phase 4 è‡ªå‹•æ˜‡æ ¼æº–å‚™å®Œäº†

          ### é”æˆæ¡ä»¶
          - âœ… Predicted@0.85 â‰¥ 85% (ç¾åœ¨: ${{ steps.shadow_eval.outputs.predicted_at_85 }}%)
          - âœ… 2é€±é€£ç¶šã§æ¡ä»¶é”æˆ

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. Phase 4ã¸ã®æ‰‹å‹•æ˜‡æ ¼ã‚’å®Ÿè¡Œ
          2. ã—ãã„å€¤ã‚’0.85ã«æ›´æ–°
          3. æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨

          ### è‡ªå‹•ç”Ÿæˆæƒ…å ±
          - æ—¥æ™‚: $(date -Iseconds)
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${GITHUB_WORKFLOW}
          - å®Ÿè¡ŒID: ${GITHUB_RUN_ID}
          `,
            labels: ['ready-for-phase4', 'golden-test', 'enhancement']
          });

    - name: Phase4æº–å‚™æœªå®Œäº†ã®å ´åˆã®æ”¹å–„ææ¡ˆIssueä½œæˆ
      if: steps.phase4_check.outputs.ready_for_phase4 == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const predicted = '${{ steps.shadow_eval.outputs.predicted_at_85 }}';
          const gap = (85 - parseFloat(predicted)).toFixed(1);

          // æ—¢å­˜ã®Improvement Issueã‚’æ¤œç´¢
          const { data: existingIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'phase4-improvement',
            state: 'open'
          });

          const bodyContent = `## Phase 4 æº–å‚™çŠ¶æ³

          ### ç¾åœ¨ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          - Predicted@0.85: ${predicted}%
          - Phase 4 Gap: ${gap}pp

          ### æ”¹å–„ææ¡ˆ
          1. **æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«è¿½åŠ **: \`norm:punc+space\`
          2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–**: \`prompt:compound-lock\`
          3. **æ•°å€¤è¿‘ä¼¼å³æ ¼åŒ–**: \`number:Â±3%\`

          ### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
          \`\`\`bash
          # æ–°è¦å¤±æ•—åˆ†æ
          python -m tests.golden.root_cause_analyzer --export-new-fails out/new_fails.json

          # æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«å€™è£œç”Ÿæˆ
          python -m tests.golden.tools.suggest_norm_rules --in out/new_fails.json --out out/norm_rule_candidates_phase4.yaml

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–å®Ÿé¨“
          python experiments/prompt_optimization.py --budget 20 --metric jaccard --out out/prompt_opt_phase4.json
          \`\`\`

          ### æ›´æ–°æ—¥æ™‚
          $(date -Iseconds)
          `;

          if (existingIssues.length > 0) {
            // æ—¢å­˜Issueã‚’æ›´æ–°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssues[0].number,
              body: bodyContent
            });
          } else {
            // æ–°ã—ã„Issueã‚’ä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Phase 4æº–å‚™: Gap ${gap}ppæ”¹å–„ãŒå¿…è¦`,
              body: bodyContent,
              labels: ['phase4-improvement', 'golden-test', 'bug']
            });
          }

    - name: é€šçŸ¥é€ä¿¡
      if: always()
      continue-on-error: true
      run: |
        SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "â­ï¸ Slacké€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼ˆSLACK_WEBHOOK_URLæœªè¨­å®šï¼‰"
          exit 0
        fi
        echo "ğŸ“¢ Sending notification..."
        python scripts/notify_results.py

    - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: phase4-evaluation-results
        path: |
          out/shadow_multi.json
          out/phase4_*.json
          out/phase4_*.marker
        retention-days: 30
