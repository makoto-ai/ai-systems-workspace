name: Golden Test Staged Promotion

on:
  schedule:
    # æ¯æ—¥09:20 JSTã«å®Ÿè¡Œï¼ˆæ®µéšæ˜‡æ ¼ãƒã‚§ãƒƒã‚¯ï¼‰
    - cron: '20 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆPRã‚’ä½œæˆã—ãªã„ï¼‰'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  staged-promotion-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyyaml

    - name: Setup environment
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        echo "GROQ_API_KEY=${GROQ_API_KEY}" >> $GITHUB_ENV

    - name: Run Multi-Shadow Grid Evaluation
      id: shadow_grid
      run: |
        echo "ğŸ” Running Multi-Shadow Grid Evaluation..."

        # æ®µéšæ˜‡æ ¼ç”¨ã‚°ãƒªãƒƒãƒ‰è©•ä¾¡å®Ÿè¡Œ
        python tests/golden/runner.py \
          --threshold-shadow "0.60,0.65,0.70,0.72,0.75,0.78,0.80,0.85" \
          --weights tests/golden/weights_phase4.yaml \
          --report out/shadow_grid.json

        echo "âœ… Grid evaluation completed"

        # çµæœè§£æ
        NEXT_RECOMMENDED=$(python -c "
        import json
        with open('out/shadow_grid.json', 'r') as f:
            data = json.load(f)
        promotion = data['multi_shadow_evaluation']['staged_promotion']
        print(f'{promotion[\"next_recommended\"]:.2f}')
        ")

        CURRENT_THRESHOLD=$(python -c "
        import json
        with open('out/shadow_grid.json', 'r') as f:
            data = json.load(f)
        promotion = data['multi_shadow_evaluation']['staged_promotion']
        print(f'{promotion[\"current_threshold\"]:.2f}')
        ")

        PROMOTION_READY=$(python -c "
        import json
        with open('out/shadow_grid.json', 'r') as f:
            data = json.load(f)
        promotion = data['multi_shadow_evaluation']['staged_promotion']
        print('true' if promotion['promotion_ready'] else 'false')
        ")

        PROMOTION_STEP=$(python -c "
        import json
        with open('out/shadow_grid.json', 'r') as f:
            data = json.load(f)
        promotion = data['multi_shadow_evaluation']['staged_promotion']
        print(f'{promotion[\"promotion_step\"]:.2f}')
        ")

        echo "next_recommended=${NEXT_RECOMMENDED}" >> $GITHUB_OUTPUT
        echo "current_threshold=${CURRENT_THRESHOLD}" >> $GITHUB_OUTPUT
        echo "promotion_ready=${PROMOTION_READY}" >> $GITHUB_OUTPUT
        echo "promotion_step=${PROMOTION_STEP}" >> $GITHUB_OUTPUT

        echo "ğŸ“Š Current: ${CURRENT_THRESHOLD}"
        echo "ğŸ¯ Next Recommended: ${NEXT_RECOMMENDED}"
        echo "ğŸš€ Promotion Ready: ${PROMOTION_READY}"

    - name: Check Promotion Historyï¼ˆ2é€£ç¶šãƒã‚§ãƒƒã‚¯ï¼‰
      id: history_check
      if: steps.shadow_grid.outputs.promotion_ready == 'true'
      run: |
        echo "ğŸ“… Checking promotion history for consecutive achievement..."

        NEXT_RECOMMENDED="${{ steps.shadow_grid.outputs.next_recommended }}"

        # éå»7æ—¥é–“ã®æ˜‡æ ¼æº–å‚™çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        WEEK_AGO_FILE="out/promotion_ready_${NEXT_RECOMMENDED}_$(date -d '7 days ago' +'%Y%m%d').marker"

        if [-f "$WEEK_AGO_FILE"]; then
          echo "âœ… 7æ—¥å‰ã‚‚åŒã˜ã—ãã„å€¤ã§æ˜‡æ ¼æº–å‚™å®Œäº†"
          echo "consecutive_achievement=true" >> $GITHUB_OUTPUT
          echo "ğŸ‰ 2é€£ç¶šã§æ˜‡æ ¼æ¡ä»¶é”æˆï¼"
        else
          echo "ğŸ”„ ä»Šå›ãŒåˆå›æº–å‚™å®Œäº†"
          echo "consecutive_achievement=false" >> $GITHUB_OUTPUT
        fi

        # ä»Šå›ã®é”æˆã‚’ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        mkdir -p out
        touch "out/promotion_ready_${NEXT_RECOMMENDED}_$(date +'%Y%m%d').marker"

    - name: Validate Promotion Step (å®‰å…¨ç¯„å›²ãƒã‚§ãƒƒã‚¯)
      id: validate_step
      if: steps.shadow_grid.outputs.promotion_ready == 'true' && steps.history_check.outputs.consecutive_achievement == 'true'
      run: |
        PROMOTION_STEP="${{ steps.shadow_grid.outputs.promotion_step }}"

        # æ˜‡æ ¼ã‚¹ãƒ†ãƒƒãƒ—ãŒå®‰å…¨ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ0.02ã€œ0.05ï¼‰
        if (( $(echo "$PROMOTION_STEP >= 0.02 && $PROMOTION_STEP <= 0.05" | bc -l) )); then
          echo "âœ… æ˜‡æ ¼ã‚¹ãƒ†ãƒƒãƒ—ãŒå®‰å…¨ç¯„å›²å†…: ${PROMOTION_STEP}"
          echo "safe_promotion_step=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ æ˜‡æ ¼ã‚¹ãƒ†ãƒƒãƒ—ãŒç¯„å›²å¤–: ${PROMOTION_STEP} (0.02-0.05 æ¨å¥¨)"
          echo "safe_promotion_step=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Staged Promotion PR
      if: |
        steps.shadow_grid.outputs.promotion_ready == 'true' &&
        steps.history_check.outputs.consecutive_achievement == 'true' &&
        steps.validate_step.outputs.safe_promotion_step == 'true' &&
        github.event.inputs.dry_run != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const currentThreshold = parseFloat('${{ steps.shadow_grid.outputs.current_threshold }}');
          const nextRecommended = parseFloat('${{ steps.shadow_grid.outputs.next_recommended }}');
          const promotionStep = parseFloat('${{ steps.shadow_grid.outputs.promotion_step }}');

          // æ–°ã—ã„config.ymlã®å†…å®¹ã‚’ç”Ÿæˆ
          const fs = require('fs');
          const yaml = require('js-yaml');

          // ç¾åœ¨ã®config.ymlã‚’èª­ã¿è¾¼ã¿
          const configContent = fs.readFileSync('tests/golden/config.yml', 'utf8');
          const config = yaml.load(configContent);

          // ã—ãã„å€¤ã‚’æ›´æ–°
          config.threshold = nextRecommended;

          // ã‚«ãƒŠãƒªã‚¢è¨­å®šã‚’è¿½åŠ 
          config.canary = {
            enabled: true,
            started_at: new Date().toISOString(),
            previous_threshold: currentThreshold,
            monitoring_duration_days: 7
          };

          const newConfigContent = yaml.dump(config);

          // ãƒ–ãƒ©ãƒ³ãƒåç”Ÿæˆ
          const branchName = `staged-promotion/threshold-${nextRecommended}`;
          const timestamp = new Date().toISOString().split('T')[0];

          // PRæœ¬æ–‡ç”Ÿæˆ
          const prBody = `## ğŸš€ æ®µéšæ˜‡æ ¼: Threshold ${currentThreshold} â†’ ${nextRecommended}

          ### æ˜‡æ ¼æ¡ä»¶é”æˆ
          - âœ… 2é€£ç¶šã§æ˜‡æ ¼æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸ
          - âœ… æ˜‡æ ¼ã‚¹ãƒ†ãƒƒãƒ— ${promotionStep:+.2f} ãŒå®‰å…¨ç¯„å›²å†…
          - âœ… shadow_pass_rate â‰¥ 80% ã‹ã¤ new_fail_ratio â‰¤ 60% ã‹ã¤ flaky_rate < 5%

          ### å¤‰æ›´å†…å®¹
          - \`tests/golden/config.yml\` ã® threshold ã‚’ ${nextRecommended} ã«æ›´æ–°
          - 7æ—¥é–“ã®ã‚«ãƒŠãƒªã‚¢ç›£è¦–ã‚’é–‹å§‹

          ### ã‚«ãƒŠãƒªã‚¢ç›£è¦–é …ç›®
          - åˆæ ¼ç‡ã®å®‰å®šæ€§
          - flaky_rate ã®å¤‰å‹•
          - new_fail_ratio ã®æ¨ç§»

          ### è‡ªå‹•ç”Ÿæˆæƒ…å ±
          - ç”Ÿæˆæ—¥æ™‚: ${new Date().toISOString()}
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: staged-promotion.yml
          - å®Ÿè¡ŒID: ${process.env.GITHUB_RUN_ID}

          **âš ï¸ ã“ã®PRã¯7æ—¥é–“ã®ã‚«ãƒŠãƒªã‚¢ç›£è¦–å¾Œã€è‡ªå‹•ã§æœ¬æ¡ç”¨åˆ¤å®šã•ã‚Œã¾ã™**
          `;

          // PRã‚’ä½œæˆ
          try {
            // ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: ref.object.sha
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
            const { data: currentFile } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'tests/golden/config.yml',
              ref: branchName
            });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'tests/golden/config.yml',
              message: `ğŸš€ Staged promotion: threshold ${currentThreshold} â†’ ${nextRecommended}`,
              content: Buffer.from(newConfigContent).toString('base64'),
              sha: currentFile.sha,
              branch: branchName
            });

            // PRã‚’ä½œæˆ
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ æ®µéšæ˜‡æ ¼: Golden Test threshold ${nextRecommended}`,
              head: branchName,
              base: 'main',
              body: prBody,
              labels: ['staged-promotion', 'golden-test', 'canary']
            });

            console.log(`âœ… æ®µéšæ˜‡æ ¼PRä½œæˆå®Œäº†: #${pr.number}`);

          } catch (error) {
            console.error('âŒ PRä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            throw error;
          }

    - name: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³çµæœè¡¨ç¤º
      if: github.event.inputs.dry_run == 'true'
      run: |
        echo "ğŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œå®Œäº†"
        echo "å®Ÿéš›ã®å®Ÿè¡Œã§ã¯ä»¥ä¸‹ã®PRãŒä½œæˆã•ã‚Œã¾ã™:"
        echo "  Current: ${{ steps.shadow_grid.outputs.current_threshold }}"
        echo "  Next: ${{ steps.shadow_grid.outputs.next_recommended }}"
        echo "  Step: ${{ steps.shadow_grid.outputs.promotion_step }}"
        echo "  Promotion Ready: ${{ steps.shadow_grid.outputs.promotion_ready }}"
        echo "  Consecutive: ${{ steps.history_check.outputs.consecutive_achievement }}"

    - name: é€šçŸ¥é€ä¿¡
      if: always()
      continue-on-error: true
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [-z "$SLACK_WEBHOOK_URL"]; then
          echo "â­ï¸ Slacké€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼ˆSLACK_WEBHOOK_URLæœªè¨­å®šï¼‰"
          exit 0
        fi
        echo "ğŸ“¢ æ®µéšæ˜‡æ ¼ãƒã‚§ãƒƒã‚¯çµæœã‚’é€šçŸ¥ä¸­..."
        python scripts/notify_results.py --staged-promotion

    - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: staged-promotion-results
        path: |
          out/shadow_grid.json
          out/promotion_ready_*.marker
        retention-days: 30
