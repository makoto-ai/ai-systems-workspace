name: "ğŸ”® Predictive Quality Assurance"

on:
  push:
    paths:
    - '.github/workflows/**'
    - 'scripts/**'
    - '**/*.py'
    - '**/*.yml'
  pull_request:
    branches: ["main", "master"]
    paths:
    - '.github/workflows/**'
    - 'scripts/**'
  schedule:
  # æ¯æ—¥æœ9æ™‚(JST)ã«äºˆé˜²ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
  - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      prediction_days:
        description: 'Prediction horizon (days)'
        required: false
        default: '7'
      apply_fixes:
        description: 'Apply preventive fixes'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  predictive-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 50  # äºˆæ¸¬åˆ†æã®ãŸã‚å±¥æ­´ã‚’å–å¾—

    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: "ğŸ“¦ Install dependencies"
      run: |
        pip install -r requirements.txt
        pip install pyyaml

    - name: "ğŸ”® Run Issue Prediction"
      id: predict
      run: |
        echo "ğŸ”® Running predictive analysis..."

        PREDICTION_DAYS="${{ github.event.inputs.prediction_days || '7' }}"

        # äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè¡Œ
        python scripts/quality/issue_predictor.py --prediction-days "${PREDICTION_DAYS}"

        # äºˆæ¸¬çµæœã®è§£æ
        if [ -f "out/issue_predictions.json" ]; then
          TOTAL_HIGH_RISK=$(jq '.risk_assessment.total_high_risk' out/issue_predictions.json)
          TOTAL_MEDIUM_RISK=$(jq '.risk_assessment.total_medium_risk' out/issue_predictions.json)
          OVERALL_RISK=$(jq -r '.risk_assessment.overall_risk_level' out/issue_predictions.json)

          {
            echo "high_risk_count=${TOTAL_HIGH_RISK}"
            echo "medium_risk_count=${TOTAL_MEDIUM_RISK}"
            echo "overall_risk=${OVERALL_RISK}"
          } >> "$GITHUB_OUTPUT"

          echo "ğŸ“Š Prediction Results:"
          echo "  High Risk Issues: ${TOTAL_HIGH_RISK}"
          echo "  Medium Risk Issues: ${TOTAL_MEDIUM_RISK}"
          echo "  Overall Risk Level: ${OVERALL_RISK}"
        else
          echo "âŒ Prediction file not generated"
          exit 1
        fi

    - name: "ğŸ›¡ï¸ Apply Preventive Fixes"
      id: prevent
      if: ${{ github.event.inputs.apply_fixes == 'true' || steps.predict.outputs.overall_risk == 'high' }}
      run: |
        echo "ğŸ›¡ï¸ Applying preventive fixes..."

        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºä¿
        mkdir -p backup/preventive_fixes

        # äºˆé˜²ä¿®æ­£ã®å®Ÿè¡Œ
        python scripts/quality/preventive_fixer.py

        # ä¿®æ­£çµæœã®ç¢ºèª
        if [ -f "out/preventive_fixes.json" ]; then
          FIXES_APPLIED=$(jq '.fixes_applied' out/preventive_fixes.json)
          SUCCESS_RATE=$(jq '.success_rate' out/preventive_fixes.json)

          {
            echo "fixes_applied=${FIXES_APPLIED}"
            echo "success_rate=${SUCCESS_RATE}"
          } >> "$GITHUB_OUTPUT"

          echo "ğŸ”§ Preventive Fixes Summary:"
          echo "  Fixes Applied: ${FIXES_APPLIED}"
          echo "  Success Rate: ${SUCCESS_RATE}"

          # ä¿®æ­£ãŒã‚ã£ãŸå ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã¨ã—ã¦è¨˜éŒ²
          if [ "${FIXES_APPLIED}" -gt 0 ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi
        fi

    - name: "ğŸ§ª Validate Applied Fixes"
      if: ${{ steps.prevent.outputs.has_changes == 'true' }}
      run: |
        echo "ğŸ§ª Validating applied fixes..."

        # YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if command -v yamllint >/dev/null 2>&1; then
          echo "ğŸ“‹ Running YAML validation..."
          yamllint .github/workflows/ || echo "âš ï¸ YAML validation warnings detected"
        fi

        # åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” Running basic syntax checks..."

        # GitHub Actions workflow validation
        for workflow in .github/workflows/*.yml; do
          echo "  Checking: $workflow"
          # åŸºæœ¬çš„ãªæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
          if ! python -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
            echo "  âŒ Syntax error in $workflow"
            exit 1
          else
            echo "  âœ… $workflow is valid"
          fi
        done

    - name: "ğŸ“Š Generate Quality Report"
      run: |
        echo "ğŸ“Š Generating comprehensive quality report..."

        # Phase 1 ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆåˆ†æ
        python scripts/dashboard/learning_insights.py
        python scripts/quality/health_monitor.py

        # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ
        cat > out/predictive_quality_report.md << 'EOF'
        # ğŸ”® Predictive Quality Assurance Report

        ## ğŸ“… Analysis Date
        $(date -Iseconds)

        ## ğŸ¯ Prediction Summary
        - **Prediction Horizon**: ${{ github.event.inputs.prediction_days || '7' }} days
        - **Overall Risk Level**: ${{ steps.predict.outputs.overall_risk }}
        - **High Risk Issues**: ${{ steps.predict.outputs.high_risk_count }}
        - **Medium Risk Issues**: ${{ steps.predict.outputs.medium_risk_count }}

        ## ğŸ›¡ï¸ Preventive Actions
        EOF

        FIXES_APPLIED="${{ steps.prevent.outputs.fixes_applied || '0' }}"
        if [ "${FIXES_APPLIED}" -gt 0 ]; then
          cat >> out/predictive_quality_report.md << 'EOF'
        - **Fixes Applied**: ${{ steps.prevent.outputs.fixes_applied }}
        - **Success Rate**: ${{ steps.prevent.outputs.success_rate }}
        - **Status**: âœ… Preventive fixes applied successfully
        EOF
        else
          cat >> out/predictive_quality_report.md << 'EOF'
        - **Status**: â„¹ï¸ No preventive fixes required
        - **System Health**: Stable
        EOF
        fi

        cat >> out/predictive_quality_report.md << 'EOF'

        ## ğŸš€ System Status
        - **Learning System**: Active
        - **Pattern Recognition**: Enabled
        - **Continuous Monitoring**: Operational

        ## ğŸ“ Generated Files
        - `out/issue_predictions.json` - Detailed predictions
        - `out/preventive_fixes.json` - Applied fixes log
        - `out/learning_insights.json` - Learning analytics
        - `out/system_health.json` - System health status

        ---
        *Report generated by Predictive Quality Assurance System*
        EOF

        echo "ğŸ“„ Quality report generated: out/predictive_quality_report.md"

    - name: "ğŸ’¾ Archive Results"
      uses: actions/upload-artifact@v4
      with:
        name: "predictive-quality-results-${{ github.run_number }}"
        path: |
          out/issue_predictions.json
          out/preventive_fixes.json
          out/predictive_quality_report.md
          out/learning_insights.json
          out/system_health.json
          backup/preventive_fixes/
        retention-days: 30

    - name: "ğŸ“ Comment on PR (if applicable)"
      if: ${{ github.event_name == 'pull_request' }}
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // äºˆæ¸¬çµæœã®èª­ã¿è¾¼ã¿
          let predictionData = {};
          try {
            predictionData = JSON.parse(fs.readFileSync('out/issue_predictions.json', 'utf8'));
          } catch (error) {
            console.log('No prediction data available');
          }

          const overallRisk = '${{ steps.predict.outputs.overall_risk }}';
          const highRiskCount = '${{ steps.predict.outputs.high_risk_count }}';
          const mediumRiskCount = '${{ steps.predict.outputs.medium_risk_count }}';
          const fixesApplied = '${{ steps.prevent.outputs.fixes_applied || '0' }}';

          const riskEmoji = overallRisk === 'high' ? 'ğŸ”´' : overallRisk === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';

          const commentBody = `## ğŸ”® Predictive Quality Analysis

          ### ${riskEmoji} Overall Risk Assessment: **${overallRisk.toUpperCase()}**

          | Metric | Count |
          |--------|-------|
          | High Risk Issues | ${highRiskCount} |
          | Medium Risk Issues | ${mediumRiskCount} |
          | Preventive Fixes Applied | ${fixesApplied} |

          ### ğŸ›¡ï¸ Preventive Actions
          ${parseInt(fixesApplied) > 0 ?
            'âœ… Preventive fixes have been applied to mitigate predicted issues.' :
            'â„¹ï¸ No preventive fixes required at this time.'}

          ### ğŸ“Š Quality Insights
          - **Prediction Horizon**: ${{ github.event.inputs.prediction_days || '7' }} days
          - **Analysis Timestamp**: ${new Date().toISOString()}
          - **Learning System**: Active and monitoring

          > ğŸ’¡ This analysis uses historical data and pattern recognition
          > to predict and prevent potential issues before they occur.

          ğŸ“ **Detailed Results**: Check the workflow artifacts for comprehensive reports.
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    - name: "ğŸš¨ High Risk Alert"
      if: ${{ steps.predict.outputs.overall_risk == 'high' }}
      run: |
        echo "ğŸš¨ HIGH RISK DETECTED!"
        echo "=============================="
        echo ""
        echo "âš ï¸ The predictive analysis has detected HIGH RISK conditions."
        echo "ğŸ“Š High Risk Issues: ${{ steps.predict.outputs.high_risk_count }}"
        echo "ğŸ”§ Preventive fixes applied: ${{ steps.prevent.outputs.fixes_applied || '0' }}"
        echo ""
        echo "ğŸ” Review the detailed predictions in the artifacts."
        echo "ğŸ›¡ï¸ Consider implementing additional preventive measures."
        echo ""
        echo "ğŸ“„ Full analysis: out/issue_predictions.json"

    - name: "âœ… Success Summary"
      if: always()
      run: |
        echo "ğŸ¯ Predictive Quality Assurance Complete"
        echo "========================================"
        echo ""
        echo "ğŸ“Š Analysis Results:"
        echo "  Overall Risk: ${{ steps.predict.outputs.overall_risk }}"
        echo "  High Risk Issues: ${{ steps.predict.outputs.high_risk_count }}"
        echo "  Medium Risk Issues: ${{ steps.predict.outputs.medium_risk_count }}"
        echo "  Preventive Fixes: ${{ steps.prevent.outputs.fixes_applied || '0' }}"
        echo ""
        echo "ğŸš€ System Status: Monitoring and learning continuously"
        echo "ğŸ“ Results archived as workflow artifacts"
