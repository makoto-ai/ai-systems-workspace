name: Enhanced System Monitoring & Security Check

on:
  schedule:
    # æ¯æ—¥9:00 JSTå®Ÿè¡Œï¼ˆå®‰å®šã—ãŸç›£è¦–ï¼‰
    - cron: '0 0 * * *'  # UTC 00:00 = JST 09:00
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
    inputs:
      test_level:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«é¸æŠ'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - comprehensive
        - full

jobs:
  system-health-check:
    name: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸ” ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ..."
        python scripts/data-integrity-check.py
        
    - name: APIçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ§ª APIçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
        if [ -f run_accurate_test.py ]; then
          python run_accurate_test.py
        else
          echo "run_accurate_test.py ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
        fi
        
    - name: ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date)" > monitoring_report.txt
        echo "ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: OK" >> monitoring_report.txt
        echo "APIçµ±åˆãƒ†ã‚¹ãƒˆ: OK" >> monitoring_report.txt
        echo "ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ­£å¸¸" >> monitoring_report.txt
        
    - name: ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring_report.txt

  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    needs: system-health-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯..."
        echo "OpenAI APIè¨­å®š: $(grep -R -c "OPENAI" . 2>/dev/null || echo 'å‰Šé™¤æ¸ˆã¿')"
        echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«: $(find . -name '*.bak' | wc -l)å€‹"
        echo "æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ä¿è­·: OK"

  notification:
    name: çµæœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [system-health-check, security-scan]
    if: always()
    
    steps:
    - name: å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
      run: |
        echo "ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œå®Œäº†"
        echo "æ—¥æ™‚: $(date)"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ­£å¸¸ç¨¼åƒä¸­"
