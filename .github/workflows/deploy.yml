name: ðŸš€ Auto Deploy via Docker

on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ” Load Secrets (GitHub or Vault)
        env:
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          WHISPERX_ENDPOINT: ${{ secrets.WHISPERX_ENDPOINT }}
        run: |
          # ã¾ãšGitHub Secretsã‚’ç’°å¢ƒã«æµã™
          if [ -n "$WHISPERX_ENDPOINT" ]; then
            echo "WHISPERX_ENDPOINT=$WHISPERX_ENDPOINT" >> "$GITHUB_ENV"
          fi

          # VAULT_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿Vaultã‚’ä½¿ã£ã¦ä¸Šæ›¸ãæ³¨å…¥
          if [ -n "$VAULT_TOKEN" ]; then
            sudo apt-get update && sudo apt-get install -y jq curl gnupg lsb-release
            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
            sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
            sudo apt-get update && sudo apt-get install -y vault
            echo "$VAULT_TOKEN" | vault login -
            SECRETS_JSON=$(vault kv get -format=json secret/ai-systems)
            echo "$SECRETS_JSON" | jq -r '.data.data | to_entries | .[] | "\(.key)=\(.value)"' >> "$GITHUB_ENV"
          fi

      - name: ðŸ§ª Run Pre-Deployment Tests
        run: |
          docker-compose -f docker-compose.yml run --rm app pytest || true

      - name: ðŸ—ï¸ Build and Restart Containers
        run: |
          docker-compose down
          docker-compose up -d --build

      - name: âœ… Health Check
        run: |
          sleep 30
          curl -f http://localhost:8000/health || echo "âš ï¸ Health check failed"

      - name: ðŸŒ Export STT Secrets
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          WHISPERX_ENDPOINT: ${{ secrets.WHISPERX_ENDPOINT }}
        run: |
          if [ -n "$GROQ_API_KEY" ]; then echo "GROQ_API_KEY=$GROQ_API_KEY" >> "$GITHUB_ENV"; fi
          if [ -n "$WHISPERX_ENDPOINT" ]; then echo "WHISPERX_ENDPOINT=$WHISPERX_ENDPOINT" >> "$GITHUB_ENV"; fi

      - name: âœ… Notify Deployment Success
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸ“Š System Status:"
          docker-compose ps
