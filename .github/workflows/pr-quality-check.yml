name: PR Quality Check - Golden Test Regression Guard

on:
  pull_request:
    branches: ["main", "master"]
    paths:
      - 'tests/golden/**'
      - 'experiments/**'
      - 'dashboard/**'
      - 'scripts/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  regression-guard:
    runs-on: ubuntu-latest
    # data-collectionãƒ©ãƒ™ãƒ«ä»˜ãPRã¯é€šå¸¸ã‚¬ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'data-collection') }}

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyyaml

    - name: Setup environment
      run: |
        echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV

    - name: Run PR Branch Shadow Evaluation
      id: pr_eval
      run: |
        echo "ğŸ” PR Branch: Shadow evaluationå®Ÿè¡Œä¸­..."

        # PRç‰ˆã§ãƒãƒ«ãƒã‚·ãƒ£ãƒ‰ãƒ¼è©•ä¾¡å®Ÿè¡Œ
        python tests/golden/runner.py \
          --threshold-shadow "0.70,0.75,0.80,0.85" \
          --weights tests/golden/weights_phase4.yaml \
          --report out/shadow_pr.json

        echo "âœ… PRè©•ä¾¡å®Œäº†"

        # çµæœæŠ½å‡º
        PR_PRED_70=$(python -c "
        import json
        with open('out/shadow_pr.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.70', {}).get('weighted_pass_rate', thresholds.get('0.70', {}).get('shadow_pass_rate', 0))
        print(f'{rate:.1f}')
        ")

        PR_PRED_85=$(python -c "
        import json
        with open('out/shadow_pr.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.85', {}).get('weighted_pass_rate', thresholds.get('0.85', {}).get('shadow_pass_rate', 0))
        print(f'{rate:.1f}')
        ")

        PR_FLAKY_RATE=$(python -c "
        import json
        with open('out/shadow_pr.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.85', {}).get('flaky_rate', 0) * 100
        print(f'{rate:.1f}')
        ")

        echo "pr_pred_70=${PR_PRED_70}" >> $GITHUB_OUTPUT
        echo "pr_pred_85=${PR_PRED_85}" >> $GITHUB_OUTPUT
        echo "pr_flaky_rate=${PR_FLAKY_RATE}" >> $GITHUB_OUTPUT

        echo "ğŸ“Š PRçµæœ: Pred@0.70=${PR_PRED_70}%, Pred@0.85=${PR_PRED_85}%, Flaky=${PR_FLAKY_RATE}%"

    - name: Checkout base branch (main) for baseline
      uses: actions/checkout@v4
      with:
        ref: main
        path: baseline

    - name: Run Baseline Shadow Evaluation
      id: baseline_eval
      working-directory: baseline
      run: |
        echo "ğŸ” Baseline (main): Shadow evaluationå®Ÿè¡Œä¸­..."

        # Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        pip install -r requirements.txt
        pip install pyyaml

        # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç‰ˆã§ãƒãƒ«ãƒã‚·ãƒ£ãƒ‰ãƒ¼è©•ä¾¡å®Ÿè¡Œ
        python tests/golden/runner.py \
          --threshold-shadow "0.70,0.75,0.80,0.85" \
          --weights tests/golden/weights_phase4.yaml \
          --report out/shadow_baseline.json

        echo "âœ… ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³è©•ä¾¡å®Œäº†"

        # çµæœæŠ½å‡º
        BASELINE_PRED_70=$(python -c "
        import json
        with open('out/shadow_baseline.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.70', {}).get('weighted_pass_rate', thresholds.get('0.70', {}).get('shadow_pass_rate', 0))
        print(f'{rate:.1f}')
        ")

        BASELINE_PRED_85=$(python -c "
        import json
        with open('out/shadow_baseline.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.85', {}).get('weighted_pass_rate', thresholds.get('0.85', {}).get('shadow_pass_rate', 0))
        print(f'{rate:.1f}')
        ")

        BASELINE_FLAKY_RATE=$(python -c "
        import json
        with open('out/shadow_baseline.json', 'r') as f:
            data = json.load(f)
        thresholds = data['multi_shadow_evaluation']['thresholds']
        rate = thresholds.get('0.85', {}).get('flaky_rate', 0) * 100
        print(f'{rate:.1f}')
        ")

        echo "baseline_pred_70=${BASELINE_PRED_70}" >> $GITHUB_OUTPUT
        echo "baseline_pred_85=${BASELINE_PRED_85}" >> $GITHUB_OUTPUT
        echo "baseline_flaky_rate=${BASELINE_FLAKY_RATE}" >> $GITHUB_OUTPUT

        echo "ğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: Pred@0.70=${BASELINE_PRED_70}%, Pred@0.85=${BASELINE_PRED_85}%, Flaky=${BASELINE_FLAKY_RATE}%"

        # çµæœã‚’PRå´ã«ã‚³ãƒ”ãƒ¼
        cp out/shadow_baseline.json ../out/

    - name: Regression Analysis
      id: regression_check
      run: |
        echo "ğŸ” å›å¸°åˆ†æå®Ÿè¡Œä¸­..."

        PR_70=${{ steps.pr_eval.outputs.pr_pred_70 }}
        PR_85=${{ steps.pr_eval.outputs.pr_pred_85 }}
        PR_FLAKY=${{ steps.pr_eval.outputs.pr_flaky_rate }}

        BASELINE_70=${{ steps.baseline_eval.outputs.baseline_pred_70 }}
        BASELINE_85=${{ steps.baseline_eval.outputs.baseline_pred_85 }}
        BASELINE_FLAKY=${{ steps.baseline_eval.outputs.baseline_flaky_rate }}

        # å·®åˆ†è¨ˆç®—ï¼ˆbashã§ã®æµ®å‹•å°æ•°ç‚¹æ¼”ç®—ï¼‰
        DIFF_70=$(python -c "print(${PR_70} - ${BASELINE_70})")
        DIFF_85=$(python -c "print(${PR_85} - ${BASELINE_85})")
        DIFF_FLAKY=$(python -c "print(${PR_FLAKY} - ${BASELINE_FLAKY})")

        echo "ğŸ“Š Performance Diff Analysis:"
        echo "  Pred@0.70: ${BASELINE_70}% â†’ ${PR_70}% (${DIFF_70:+}pp)"
        echo "  Pred@0.85: ${BASELINE_85}% â†’ ${PR_85}% (${DIFF_85:+}pp)"
        echo "  Flaky Rate: ${BASELINE_FLAKY}% â†’ ${PR_FLAKY}% (${DIFF_FLAKY:+}pp)"

        # å›å¸°åˆ¤å®š
        REGRESSION_DETECTED=false
        REGRESSION_REASONS=()

        # Pred@0.70ãŒ1.0ppä»¥ä¸Šæ‚ªåŒ–
        if (( $(echo "${DIFF_70} < -1.0" | bc -l) )); then
          REGRESSION_DETECTED=true
          REGRESSION_REASONS+=("Pred@0.70ãŒ${DIFF_70}ppæ‚ªåŒ–ï¼ˆ-1.0ppé–¾å€¤ï¼‰")
        fi

        # Pred@0.85ãŒ1.0ppä»¥ä¸Šæ‚ªåŒ–
        if (( $(echo "${DIFF_85} < -1.0" | bc -l) )); then
          REGRESSION_DETECTED=true
          REGRESSION_REASONS+=("Pred@0.85ãŒ${DIFF_85}ppæ‚ªåŒ–ï¼ˆ-1.0ppé–¾å€¤ï¼‰")
        fi

        # Flakyç‡ãŒ2.0ppä»¥ä¸Šå¢—åŠ 
        if (( $(echo "${DIFF_FLAKY} > 2.0" | bc -l) )); then
          REGRESSION_DETECTED=true
          REGRESSION_REASONS+=("Flakyç‡ãŒ${DIFF_FLAKY}ppå¢—åŠ ï¼ˆ+2.0ppé–¾å€¤ï¼‰")
        fi

        # çµæœå‡ºåŠ›
        echo "regression_detected=${REGRESSION_DETECTED}" >> $GITHUB_OUTPUT
        echo "diff_70=${DIFF_70}" >> $GITHUB_OUTPUT
        echo "diff_85=${DIFF_85}" >> $GITHUB_OUTPUT
        echo "diff_flaky=${DIFF_FLAKY}" >> $GITHUB_OUTPUT

        # å›å¸°ç†ç”±ã‚’JSONã§ä¿å­˜
        if [ "$REGRESSION_DETECTED" = true ]; then
          printf '%s\n' "${REGRESSION_REASONS[@]}" > regression_reasons.txt
          echo "âŒ å›å¸°æ¤œå‡ºï¼ç†ç”±:"
          cat regression_reasons.txt | sed 's/^/  - /'
        else
          echo "âœ… å›å¸°ãªã— - PRæ‰¿èªå¯èƒ½"
        fi

    - name: Quality Gate Check
      id: quality_gate
      run: |
        echo "ğŸ” å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."

        REGRESSION=${{ steps.regression_check.outputs.regression_detected }}

        if [ "$REGRESSION" = "true" ]; then
          echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆ: FAILED"
          exit 1
        else
          echo "quality_gate_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆ: PASSED"
        fi

    - name: Update PR with Regression Analysis
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const regressionDetected = '${{ steps.regression_check.outputs.regression_detected }}' === 'true';
          const qualityGatePassed = '${{ steps.quality_gate.outputs.quality_gate_passed }}' === 'true';

          const diff70 = parseFloat('${{ steps.regression_check.outputs.diff_70 }}');
          const diff85 = parseFloat('${{ steps.regression_check.outputs.diff_85 }}');
          const diffFlaky = parseFloat('${{ steps.regression_check.outputs.diff_flaky }}');

          const prPred70 = '${{ steps.pr_eval.outputs.pr_pred_70 }}';
          const prPred85 = '${{ steps.pr_eval.outputs.pr_pred_85 }}';
          const baselinePred70 = '${{ steps.baseline_eval.outputs.baseline_pred_70 }}';
          const baselinePred85 = '${{ steps.baseline_eval.outputs.baseline_pred_85 }}';

          let statusEmoji = 'âœ…';
          let statusText = 'å“è³ªã‚²ãƒ¼ãƒˆ: PASSED';
          let alertLevel = 'info';

          if (regressionDetected) {
            statusEmoji = 'âŒ';
            statusText = 'å“è³ªã‚²ãƒ¼ãƒˆ: FAILED - å›å¸°æ¤œå‡º';
            alertLevel = 'error';
          }

          const commentBody = `## ${statusEmoji} PRå“è³ªãƒã‚§ãƒƒã‚¯çµæœ

          ### ğŸ“Š Performance Impact Analysis

          | Metric | Baseline | PR | Diff | Status |
          |--------|----------|----|----|-------|
          | Pred@0.70 | ${baselinePred70}% | ${prPred70}% | ${diff70:+.1f}pp | ${diff70 >= -1.0 ? 'âœ…' : 'âŒ'} |
          | Pred@0.85 | ${baselinePred85}% | ${prPred85}% | ${diff85:+.1f}pp | ${diff85 >= -1.0 ? 'âœ…' : 'âŒ'} |
          | Flaky Rate | ${{ steps.baseline_eval.outputs.baseline_flaky_rate }}% | ${{ steps.pr_eval.outputs.pr_flaky_rate }}% | ${diffFlaky:+.1f}pp | ${diffFlaky <= 2.0 ? 'âœ…' : 'âŒ'} |

          ### ğŸš¦ Quality Gate Rules
          - **Pred@0.70**: æ‚ªåŒ–ã¯-1.0ppä»¥å†…
          - **Pred@0.85**: æ‚ªåŒ–ã¯-1.0ppä»¥å†…
          - **Flaky Rate**: å¢—åŠ ã¯+2.0ppä»¥å†…

          ${regressionDetected ? `
          ### âŒ å›å¸°æ¤œå‡ºç†ç”±
          ${require('fs').existsSync('regression_reasons.txt') ? require('fs').readFileSync('regression_reasons.txt', 'utf8').split('\n').filter(line => line).map(line => `- ${line}`).join('\n') : ''}

          **ã“ã®PRã¯å“è³ªã‚²ãƒ¼ãƒˆã‚’é€šéã—ã¦ã„ã¾ã›ã‚“ã€‚å›å¸°ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚**
          ` : `
          ### âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé
          ã“ã®PRã¯å›å¸°ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ã¾ã—ãŸã€‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚
          `}

          ### ğŸ” è©³ç´°ãƒ‡ãƒ¼ã‚¿
          - PRè©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ: \`out/shadow_pr.json\`
          - ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³è©•ä¾¡: \`out/shadow_baseline.json\`
          - å®Ÿè¡ŒID: \`${process.env.GITHUB_RUN_ID}\`
          `;

          // PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ /æ›´æ–°
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });

          const botComment = comments.find(comment =>
            comment.user.login === 'github-actions[bot]' &&
            comment.body.includes('PRå“è³ªãƒã‚§ãƒƒã‚¯çµæœ')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
          }

          // å›å¸°æ¤œå‡ºæ™‚ã¯PRã‚’ãƒ‰ãƒ©ãƒ•ãƒˆã«å¤‰æ›´ã™ã‚‹æ¤œè¨
          if (regressionDetected) {
            console.log('âŒ å›å¸°æ¤œå‡ºã«ã‚ˆã‚ŠCIå¤±æ•—');
          }

    - name: Archive Quality Check Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-quality-check-results
        path: |
          out/shadow_pr.json
          out/shadow_baseline.json
          regression_reasons.txt
        retention-days: 30

    - name: Fail CI on Regression
      if: steps.regression_check.outputs.regression_detected == 'true'
      run: |
        echo "âŒ CIå¤±æ•—: å“è³ªã‚²ãƒ¼ãƒˆã§ã®å›å¸°æ¤œå‡ºã«ã‚ˆã‚Šã€ã“ã®PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“"
        exit 1

  # ãƒ‡ãƒ¼ã‚¿åé›†å°‚ç”¨: ã‚µãƒãƒªãƒ¼ç”Ÿæˆã¯å¸¸ã«å®Ÿè¡Œ
  data-collection-summary:
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyyaml

    - name: Setup environment
      run: |
        echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV

    - name: Run Shadow Grid Evaluation
      run: |
        echo "ğŸ“Š Shadow Gridè©•ä¾¡å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿åé›†ç”¨ï¼‰"
        python tests/golden/runner.py \
          --threshold-shadow "0.70,0.72,0.75,0.80,0.85" \
          --weights tests/golden/weights_phase4.yaml \
          --report out/shadow_grid.json

    - name: Archive Shadow Results
      uses: actions/upload-artifact@v4
      with:
        name: shadow-grid-data-collection
        path: out/shadow_grid.json
        retention-days: 30

    - name: Early Abort Check
      if: contains(github.event.pull_request.labels.*.name, 'data-collection')
      id: abort_check
      run: |
        echo "ğŸ” æ—©æœŸAbortåˆ¤å®šå®Ÿè¡Œ"
        python scripts/decide_abort.py \
          --shadow out/shadow_grid.json \
          --threshold 0.72 \
          --hard-min-pass 0.65 \
          --hard-max-new 0.70

        # çµæœã‚’å‡ºåŠ›ã«ä¿å­˜
        echo "abort=$ABORT" >> $GITHUB_OUTPUT
        echo "reason=$ABORT_REASON" >> $GITHUB_OUTPUT

    - name: Close PR if Abort
      if: |
        contains(github.event.pull_request.labels.*.name, 'data-collection') &&
        steps.abort_check.outputs.abort == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const reason = process.env.ABORT_REASON || 'æ—©æœŸAbortæ¡ä»¶ã«è©²å½“';

          // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: `ğŸ›‘ **æ—©æœŸAbort: ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†**\n\n${reason}\n\nã“ã®PRã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚åé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã‹ã‚‰ç¢ºèªã§ãã¾ã™:\n- Shadow Gridçµæœ: Artifactsã‚¿ãƒ–\n- è©³ç´°åˆ†æ: Actionsãƒ­ã‚°`
          });

          // PRã‚¯ãƒ­ãƒ¼ã‚º
          await github.rest.pulls.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
            state: 'closed'
          });

          console.log(`âœ… PR #${prNumber} ã‚’æ—©æœŸAbortã«ã‚ˆã‚Šã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ`);

    - name: Notify Slack (Data Collection)
      if: always()
      continue-on-error: true
      run: |
        SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "â­ï¸ Slacké€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼ˆSLACK_WEBHOOK_URLæœªè¨­å®šï¼‰"
          exit 0
        fi
        echo "ğŸ“¢ ãƒ‡ãƒ¼ã‚¿åé›†çµæœã‚’Slacké€šçŸ¥"
        python scripts/notify_results.py \
          --data-collection \
          --action-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          --pr-url "${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
