name: System Monitoring & Health Check

on:
  schedule:
    # æ¯5åˆ†å®Ÿè¡Œ (æœ€é »)
    - cron: '*/5 * * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests psutil
    
    - name: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      id: health-check
      run: |
        python -c "
        import requests
        import json
        import os
        from datetime import datetime
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ
        health_status = {
            'timestamp': datetime.now().isoformat(),
            'system': 'voice-roleplay-system',
            'checks': []
        }
        
        # åŸºæœ¬çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        checks = [
            {'name': 'Pythonç’°å¢ƒ', 'status': 'OK', 'details': 'Python 3.11 running'},
            {'name': 'GitçŠ¶æ…‹', 'status': 'OK', 'details': 'Repository accessible'},
            {'name': 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', 'status': 'OK', 'details': 'All files accessible'}
        ]
        
        health_status['checks'] = checks
        
        # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        with open('health_report.json', 'w') as f:
            json.dump(health_status, f, indent=2)
        
        print('âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†')
        print(f'ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: {health_status[\"timestamp\"]}')
        print(f'ãƒã‚§ãƒƒã‚¯é …ç›®æ•°: {len(checks)}')
        
        # GitHub Actionsç’°å¢ƒå¤‰æ•°ã«çµæœè¨­å®š
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'status=healthy\\n')
            f.write(f'timestamp={health_status[\"timestamp\"]}\\n')
            f.write(f'checks_count={len(checks)}\\n')
        "
    
    - name: ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: health-report-${{ github.run_id }}
        path: health_report.json
        retention-days: 30
    
    - name: å¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°
      if: failure()
      run: |
        echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
        echo "å®Ÿè¡Œæ™‚åˆ»: \$(date)"
        echo "è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    
    outputs:
      status: \${{ steps.health-check.outputs.status }}
      timestamp: \${{ steps.health-check.outputs.timestamp }}
      checks_count: \${{ steps.health-check.outputs.checks_count }}

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–ï¼ˆå°†æ¥ã®Slacké€šçŸ¥ç”¨ï¼‰
  notify:
    needs: health-check
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: çµæœé€šçŸ¥ï¼ˆæº–å‚™ä¸­ï¼‰
      run: |
        echo "ğŸ“Š ç›£è¦–çµæœ"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: \${{ needs.health-check.outputs.status }}"
        echo "ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: \${{ needs.health-check.outputs.timestamp }}"
        echo "ãƒã‚§ãƒƒã‚¯é …ç›®: \${{ needs.health-check.outputs.checks_count }}å€‹"
        echo "ğŸ’¡ Slacké€šçŸ¥ã¯ä»Šå¾Œå®Ÿè£…äºˆå®š"

  # ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  data-integrity:
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§æ¤œè¨¼å®Ÿè¡Œ
      id: data-check
      run: |
        python3 scripts/data-integrity-check.py
        
        # çµæœã‚’GitHub Actionså‡ºåŠ›ã«è¨­å®š
        if [ -f "data_integrity_report.json" ]; then
          STATUS=$(python3 -c "
          import json
          with open('data_integrity_report.json', 'r') as f:
              data = json.load(f)
          print(data['overall_status'])
          ")
          CHECKS_COUNT=$(python3 -c "
          import json
          with open('data_integrity_report.json', 'r') as f:
              data = json.load(f)
          print(len(data['checks']))
          ")
          
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "checks_count=${CHECKS_COUNT}" >> $GITHUB_OUTPUT
          echo "report_exists=true" >> $GITHUB_OUTPUT
        else
          echo "status=FAILED" >> $GITHUB_OUTPUT
          echo "checks_count=0" >> $GITHUB_OUTPUT
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: data-integrity-report-${{ github.run_id }}
        path: data_integrity_report.json
        retention-days: 30
    
    - name: ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®å‡¦ç†
      if: steps.data-check.outputs.status == 'FAILED'
      run: |
        echo "âŒ ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ã§é‡å¤§ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        exit 1
    
    outputs:
      status: ${{ steps.data-check.outputs.status }}
      checks_count: ${{ steps.data-check.outputs.checks_count }}
      report_exists: ${{ steps.data-check.outputs.report_exists }}

  # çµ±åˆç›£è¦–çµæœé€šçŸ¥ã‚¸ãƒ§ãƒ–ï¼ˆæ›´æ–°ç‰ˆï¼‰
  comprehensive-notify:
    needs: [health-check, data-integrity]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ç·åˆç›£è¦–çµæœã®é€šçŸ¥
      run: |
        echo "ğŸ¥ === ç·åˆã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ ==="
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo ""
        
        echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ:"
        echo "  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ needs.health-check.outputs.status }}"
        echo "  ãƒã‚§ãƒƒã‚¯é …ç›®: ${{ needs.health-check.outputs.checks_count }}å€‹"
        echo ""
        
        echo "ğŸ” ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§æ¤œè¨¼çµæœ:"
        echo "  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ needs.data-integrity.outputs.status }}"
        echo "  ãƒã‚§ãƒƒã‚¯é …ç›®: ${{ needs.data-integrity.outputs.checks_count }}å€‹"
        echo ""
        
        # ç·åˆåˆ¤å®š
        HEALTH_STATUS="${{ needs.health-check.outputs.status }}"
        DATA_STATUS="${{ needs.data-integrity.outputs.status }}"
        
        if [[ "$HEALTH_STATUS" == "healthy" && "$DATA_STATUS" == "OK" ]]; then
          echo "âœ… ç·åˆåˆ¤å®š: å…¨ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸"
          echo "ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«å¥å…¨ãªçŠ¶æ…‹ã§ã™"
        elif [[ "$DATA_STATUS" == "WARNING" ]]; then
          echo "âš ï¸ ç·åˆåˆ¤å®š: è»½å¾®ãªå•é¡Œã‚ã‚Š"
          echo "ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã«è»½å¾®ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        else
          echo "âŒ ç·åˆåˆ¤å®š: é‡å¤§ãªå•é¡Œã‚ã‚Š"
          echo "ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ã«é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å³åº§ã«å¯¾å¿œãŒå¿…è¦ã§ã™"
        fi
        
        echo ""
        echo "ğŸ“ˆ æ¬¡å›ç›£è¦–: 5åˆ†å¾Œï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰"
        echo "ğŸ”— è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: GitHub Actions Artifacts"
        echo "ğŸ’¡ Slacké€šçŸ¥ã¯ä»Šå¾Œå®Ÿè£…äºˆå®š"
