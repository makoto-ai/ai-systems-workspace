# バックアップ＆復旧 システム 運用ガイド

## 目的
- ローカル日次＋R2暗号化（世代管理）＋復元検証で確実復旧。

## 構成/スクリプト
- 日次: `scripts/backup/daily_backup.sh`（DBダンプ→rsync／30日で削除）
- DBダンプ: `scripts/backup/db_dump.sh`（`DATABASE_URL` or `PG*`）
- R2暗号化: `scripts/backup/restic_backup.sh`（check/forget-prune）
- 復元検証: `scripts/backup/restic_restore_verify.sh`
- 週次フル（任意）: `scripts/backup/system_full_backup.sh`
- 対象: `ai-systems-workspace`, `Backups/db`, `Obsidian`, `whisperx_outputs`

## 設定
- `scripts/backup/restic.env`
```bash
RESTIC_REPOSITORY="s3:https://<ACCOUNT_ID>.r2.cloudflarestorage.com/<BUCKET>"
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
RESTIC_PASSWORD=...
BACKUP_PATHS=("$HOME/ai-driven/ai-systems-workspace"  "$HOME/Library/Mobile Documents/com~apple~CloudDocs/Obsidian"  "$HOME/whisperx_outputs" "$HOME/Backups/db")
```
- `scripts/backup/db.env`
```bash
DATABASE_URL="postgres://USER:PASSWORD@HOST:5432/DBNAME"
```

## スケジュール（cron）
- 03:00: `daily_backup.sh`
- 04:00: `restic_backup.sh`
- 週次 04:30: `restic_restore_verify.sh`

## 復旧
```bash
restic -r "$RESTIC_REPOSITORY" restore latest --target ~/
pg_restore -d <DB名> ~/Backups/db/pg_<DB名>_<日時>.dump
```

## 検証/ログ
- `logs/backup_YYYY-MM-DD.log`
- `logs/restic_backup.log`
- `logs/restic_restore_verify.log`

更新: 2025-08-14 16:49
